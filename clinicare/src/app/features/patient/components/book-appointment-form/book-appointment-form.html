<form
  class="w-full max-w-2xl dark:bg-[#0A1120] bg-white p-6 sm:p-8 rounded-2xl shadow-xl flex flex-col"
  autocomplete="off"
  [formGroup]="appointmentForm"
  (ngSubmit)="submit()"
>
  <div class="flex flex-col gap-5 py-4">
    <!-- Nombre Completo -->
    <div class="flex flex-col">
      <label
        class="input flex items-center gap-3 p-3 border rounded-xl focus-within:ring-2 focus-within:ring-secondary w-full floating-label"
      >
        <span class="text-gray-800 dark:text-slate-300"
          >Tu Nombre Completo</span
        >

        <!-- <address-field-icon /> -->

        <input
          type="text"
          class="grow text-base sm:text-md text-gray-500 dark:text-gray-300 focus:outline-none py-3"
          [placeholder]="loggedUser()?.name + ' ' + loggedUser()?.last_name"
          [value]="loggedUser()?.name + ' ' + loggedUser()?.last_name"
          readonly
        />
      </label>
    </div>

    <!-- Tipo de cita -->
    <div class="flex flex-col">
      <select
        class="select text-base text-gray-600 dark:text-gray-300 sm:text-md w-full"
        formControlName="appointmentType"
        [class.text-gray-500]="!appointmentForm.get('appointmentType')?.value"
      >
        <option value="" selected disabled>Elige el tipo de la consulta</option>
        <option value="PRESENTIAL" class="text-gray-600 dark:text-gray-200">
          <man-field-icon />
          Presencial
        </option>
        <option value="TELEHEALTH" class="text-gray-600 dark:text-gray-200">
          <mobile-field-icon />
          Telematica
        </option>
      </select>

      <span
        class="block text-xs text-error mt-1 min-h-[1rem]"
        [class.opacity-0]="!formUtils.isValidField(appointmentForm, 'appointmentType')"
      >
        {{ formUtils.getFieldError(appointmentForm, 'appointmentType') }}
      </span>
    </div>

    <div class="flex flex-col">
      <select
        class="select text-base sm:text-md w-full text-gray-600 dark:text-gray-300"
        formControlName="speciality"
        [class.text-gray-500]="!appointmentForm.get('speciality')?.value"
        (change)="onSpecialityChange($event)"
      >
        <option value="" selected disabled>Seleccione una especialidad</option>
        @for (speciality of specialities(); track speciality.id) {
        <option
          [value]="speciality.id"
          class="text-gray-600 dark:text-gray-200"
        >
          {{ speciality.name }}
        </option>
        }
      </select>

      <span
        class="block text-xs text-error mt-1 min-h-[1rem]"
        [class.opacity-0]="!formUtils.isValidField(appointmentForm, 'speciality')"
      >
        {{ formUtils.getFieldError(appointmentForm, 'speciality') }}
      </span>
    </div>

    <!-- Seleccionar doctor según especialidad -->
    <div class="flex flex-col">
      <select
        class="select text-base sm:text-md w-full text-gray-600 dark:text-gray-300"
        name="doctorId"
        formControlName="doctorId"
        [disabled]="disableDoctorSelect()"
        [class.pointer-events-none]="disableDoctorSelect()"
        [class.opacity-50]="disableDoctorSelect()"
      >
        @for (doctor of availableDoctors(); track doctor.id) {
        <option [value]="doctor.id" class="text-gray-600 dark:text-gray-200">
          @if (doctor.profile_user_image) {
          <img
            class="aspect-video size-12 rounded-full mr-2"
            [src]="doctor.profile_user_image"
            [alt]="doctor.name + ' ' + doctor.last_name"
          />
          } @else {
          <img
            class="size-8"
            src="https://img.daisyui.com/images/profile/demo/2@94.webp"
            alt="Imagen Placeholder de Usuario"
          />
          } {{ doctor.name }} {{ doctor.last_name || '' }}
        </option>
        }
      </select>

      <span class="block text-xs text-error mt-1 min-h-[1rem]">
        <!-- No hay doctores disponibles -->
        @if (specialitySelected() && availableDoctors().length === 0) { No hay
        doctores disponibles para esta especialidad. }
        <!-- Hay doctores pero no se ha seleccionado ninguno -->
        @else if (specialitySelected() && availableDoctors().length > 0 &&
        !doctorSelected()) { Por favor, elige un doctor de la lista. }
        <!-- Especialidad y doctor seleccionado -->
        @else { &nbsp; }
      </span>
    </div>

    <div class="flex flex-col w-full mb-1">
      <label class="text-gray-800 dark:text-slate-300">
        Fecha y Hora de la Cita
      </label>

      <app-custom-datepicker
        formControlName="appointmentDate"
        [formGroup]="appointmentForm"
        class="mt-1"
      ></app-custom-datepicker>

      <span
        class="block text-xs text-error mt-1 min-h-[1rem]"
        [class.opacity-0]="!formUtils.isValidField(appointmentForm, 'appointmentDate')"
      >
        {{ formUtils.getFieldError(appointmentForm, 'appointmentDate') }}
      </span>
    </div>

    <div class="flex flex-col">
      <label class="text-gray-800 dark:text-slate-300"
        >Motivo de la consulta

        <textarea
          class="grow text-base sm:text-md text-gray-500 dark:text-gray-300 textarea resize-none border rounded-xl mb-3 w-full mt-1"
          placeholder="Escribe aquí el motivo de tu cita aquí..."
          name="reason"
          formControlName="reason"
        ></textarea>
        <span
          class="block text-xs text-error mt-1 min-h-[1rem]"
          [class.opacity-0]="
              !formUtils.isValidField(appointmentForm, 'reason')
            "
        >
          {{ formUtils.getFieldError(appointmentForm, "reason") }}
        </span>
      </label>
    </div>
  </div>

  <!-- BOTÓN -->
  <button
    type="submit"
    class="btn btn-secondary py-2 sm:py-3 text-base sm:text-md rounded-xl hover:scale-[102px] transition-transform"
    [disabled]="appointmentForm.invalid"
  >
    Crear Cita
  </button>
</form>
